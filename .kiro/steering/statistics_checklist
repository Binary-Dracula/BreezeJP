# 统计相关改动 Checklist（必过）

> **适用范围**
> 任何 PR / 改动 **只要涉及以下任一关键词**，必须完整对照本清单逐条确认：
>
> * daily_stats
> * 学习时长 / duration / time
> * 今日学习 / 今日复习
> * 连续学习（streak）
> * 累计掌握
> * study_logs / kana_logs
> * session / 行为统计

---

## 一、时间统计（学习时长）

### ✅ 必须满足

* [ ] 是否 **仅** 通过 `PageDurationTracker` 统计时间？
* [ ] 是否 **仅** 调用 `DailyStatCommand.applyTimeOnlyDelta` 写入时间？
* [ ] 是否 **只更新** `daily_stats.total_time_ms`？
* [ ] 是否满足最小统计阈值（当前 ≥ 2000ms）？

### ❌ 严格禁止

* [ ] 是否 **完全没有** 从以下来源写入或推导时间？

  * study_logs / kana_logs
  * session / 行为 / rating
  * 学习完成回调
* [ ] 是否 **没有** 在任何日志或行为中携带 `durationMs`？
* [ ] 是否 **没有** 页面直接操作 `daily_stats` 表？

👉 **只要有一条 ❌，该改动必须回滚或重构**

---

## 二、今日学习 / 今日复习

### 定义确认

* [ ] 今日学习 = `daily_stats.new_learned_count`
* [ ] 今日复习 = `daily_stats.review_count`

### 写入规则

* [ ] 是否仅在 **学习 / 复习行为发生时** 做增量更新？
* [ ] 是否未通过以下方式计算“今日”？

  * 日志回放
  * 库存表统计
  * 状态表推导

### 禁止项

* [ ] 是否 **没有** 从 `study_logs / kana_logs` 查询今日数据？
* [ ] 是否 **没有** 在 UI 层做任何统计计算？

---

## 三、累计掌握（Mastered）

### 唯一数据源

* [ ] 单词：`study_words.user_state = mastered`
* [ ] 假名：`kana_learning_state.learning_status = mastered`

### 确认项

* [ ] 是否 **只做 COUNT，不做 SUM，不依赖时间**？
* [ ] 是否未从以下位置读取累计掌握？

  * daily_stats
  * logs
  * session

👉 **累计掌握 ≠ 今日学习 × 天数**

---

## 四、连续学习（Streak）

### 唯一来源

* [ ] 是否 **只使用 daily_stats** 计算 streak？

### 判定标准

* [ ] 是否以「当天或昨天存在任意有效学习行为或学习时长」作为 anchor？
* [ ] 是否不关心“学了多少”，只关心“是否活跃”？

### 实现方式

* [ ] 是否使用 **gaps-and-islands**（非递归 CTE）？
* [ ] 是否避免使用 Dart 对 date 字符串做逻辑计算？

### 禁止项

* [ ] 是否 **没有** 从 logs 回放计算 streak？
* [ ] 是否 **没有** 设置任意上限（如 365 天）？

---

## 五、结构与职责边界

### 架构确认

* [ ] UI 层：**只读，不算**
* [ ] Command：**只写，不算**
* [ ] Query / Analytics：**只查，不写**
* [ ] Tracker：**只统计时间，不关心业务**

### 禁止的反模式（逐条确认）

* [ ] ❌ 页面直接操作 daily_stats
* [ ] ❌ 在行为日志中维护 durationMs
* [ ] ❌ 同一指标存在两个数据源
* [ ] ❌ 为“方便”在 UI 中补算统计
* [ ] ❌ 引入第二套统计表或缓存统计结果

---

## 六、最终自问（必须回答）

在提交本改动前，**必须能明确回答以下问题**：

1. **这个统计值的唯一事实表是哪张？**
2. **它是“状态”还是“事件”？**
3. **它是否依赖时间？如果依赖，时间来自哪里？**
4. **如果 logs 全部删除，这个统计是否仍然成立？**
5. **半年后我回来看，还能不能一眼说清数据来源？**

> 只要有一个问题答不上来
> 👉 **说明统计设计还没完成**

---

## 封板声明（建议原文保留）

> **统计系统已封板**
>
> * 所有统计指标已确定唯一数据源
> * 所有写入路径已收口
> * 不接受“临时方案 / 过渡逻辑 / 先跑起来”
>
> 任何新增统计需求，必须：
>
> 1️⃣ 先更新技术文档
> 2️⃣ 再通过本 Checklist
> 3️⃣ 最后才允许写代码