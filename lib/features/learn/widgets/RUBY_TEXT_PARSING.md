# Ruby Text 解析说明

## 解析策略

当前的解析逻辑正确处理日语假名注音格式。

### 正则表达式

```dart
r'<b>(.*?)<\/b>'                    // group1: bold text
r'|([\u4e00-\u9fff]+)\[([^\]]+)\]'  // group2: 汉字, group3: ruby
```

### 关键规则

**`[假名]` 对应的是前面所有连续的汉字**

- `[\u4e00-\u9fff]+` 匹配一个或多个汉字
- `悪事[あくじ]` → "悪事" 整体的假名是 "あくじ"
- `駆[か]` → "駆" 的假名是 "か"

### 关键点

1. **`(\S)\[([^\]]+)\]`** - 只匹配**单个非空白字符**后跟 `[ruby]`
   - `\S` 匹配单个非空白字符
   - 这确保了 "を 悪事[あくじ]" 会被正确拆分为 "を "、"悪[あく]"、"事[じ]"

2. **`(.)`** - 匹配任意单个字符
   - 包括空格、假名、汉字等
   - 连续的普通字符会被合并以提高效率

## 解析示例

### 示例 1: `人[ひと]を 悪事[あくじ]に<b> 駆[か]り 立[た]てる</b>`

解析结果：
```
人[ひと]       -> RubyTextData("人", ruby: "ひと")
を             -> RubyTextData("を ")
悪事[あくじ]   -> RubyTextData("悪事", ruby: "あくじ")  ✅ 整个词
に             -> RubyTextData("に")
<b>内容</b>    -> 递归处理，isBoldContext = true
  (空格)       -> RubyTextData(" ", bold)
  駆[か]       -> RubyTextData("駆", ruby: "か", bold)
  り           -> RubyTextData("り ", bold)
  立[た]       -> RubyTextData("立", ruby: "た", bold)
  てる         -> RubyTextData("てる", bold)
```

### 示例 2: `友達[ともだち]が 誕生[たんじょう] 日[び]プレゼントを<b>くれた</b>`

解析结果：
```
友達[ともだち]     -> RubyTextData("友達", ruby: "ともだち")  ✅ 整个词
が                 -> RubyTextData("が ")
誕生[たんじょう]   -> RubyTextData("誕生", ruby: "たんじょう")  ✅ 整个词
(空格)             -> RubyTextData(" ")
日[び]             -> RubyTextData("日", ruby: "び")
プレゼントを       -> RubyTextData("プレゼントを")
<b>くれた</b>      -> RubyTextData("くれた", bold)
```

## 为什么这样设计？

### 问题

原来的正则 `([^\[\]<>]+)\[([^\]]+)\]` 会贪婪匹配，导致：
- "を 悪事[あくじ]" 被错误匹配为 base="を 悪事", ruby="あくじ"
- "り 立[た]" 被错误匹配为 base="り 立", ruby="た"

这是**错误的**，因为：
- 假名 "あくじ" 只对应汉字 "悪事"，不包括 "を "
- 假名 "た" 只对应汉字 "立"，不包括 "り "

### 解决方案

使用 `([\u4e00-\u9fff]+)\[([^\]]+)\]` 只匹配**汉字**：
- `[\u4e00-\u9fff]+` 匹配一个或多个汉字（Unicode 汉字范围）
- "悪事[あくじ]" 正确匹配为 base="悪事", ruby="あくじ" ✅
- "を " 作为普通文本单独处理 ✅
- " " 空格作为普通文本单独处理 ✅

### 数据格式支持

这个解析器支持：
```
汉字词[完整假名]  # 支持多字符汉字词
```

例如：
- `友達[ともだち]` ✅ 正确
- `悪事[あくじ]` ✅ 正确
- `駆[か]` ✅ 正确
- `立[た]` ✅ 正确

## 字符合并优化

为了避免产生过多的 `RubyTextData` 对象，解析器会自动合并连续的普通字符：

```dart
if (result.isNotEmpty && 
    result.last.ruby == null && 
    result.last.style?.fontWeight == currentWeight) {
  // 合并到上一个 RubyTextData
  result.last.text += singleChar;
}
```

例如：
- "を" + " " -> "を "
- "プ" + "レ" + "ゼ" + "ン" + "ト" + "を" -> "プレゼントを"

## 建议

### 1. 数据库格式

确保数据库中的 `sentence_furigana` 字段格式正确：

```sql
-- 正确格式（每个汉字单独标注）
UPDATE example_sentences 
SET sentence_furigana = '人[ひと]を 悪[あく]事[じ]に<b> 駆[か]り 立[た]てる</b>'
WHERE sentence_furigana = '人[ひと]を 悪事[あくじ]に<b> 駆[か]り 立[た]てる</b>';
```

### 2. 数据预处理

如果数据库中有大量 "多字符词[完整假名]" 格式，需要编写脚本转换：

```dart
String convertToSingleCharRuby(String text) {
  // 将 "友達[ともだち]" 转换为 "友[とも]達[だち]"
  // 这需要知道每个汉字对应的假名分配
  // 可能需要使用 kana_kit 或其他工具
}
```

### 3. 使用自定义 Ruby Text

如果需要支持多字符词的假名标注，可以使用 `lib/core/widgets/custom_ruby_text.dart`，它支持更灵活的格式。

## 总结

当前的解析器：
- ✅ 正确处理单个字符 + 假名的格式
- ✅ 正确分离空格和其他字符
- ✅ 正确处理 `<b>` 标签
- ✅ 自动合并连续的普通字符
- ❌ 不支持多字符词 + 完整假名的格式（需要数据格式调整）

如果数据库格式是 "多字符词[完整假名]"，需要：
1. 修改数据库数据格式
2. 或者修改解析器以支持这种格式（但会更复杂）
